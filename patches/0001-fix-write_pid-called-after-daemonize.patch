From 0bf8c44a6282b7e298e956d38bc09c9abbd46c29 Mon Sep 17 00:00:00 2001
From: Hiroaki KAWAI <kawai@stratosphere.co.jp>
Date: Sat, 20 Apr 2013 00:59:37 +0900
Subject: [PATCH] fix write_pid called after daemonize call

To control daemonized process, we must call write_pid
after the daemonize() call.

Signed-off-by: Hiroaki KAWAI <kawai@stratosphere.co.jp>
---
 src/switch/switch/switch-init.c |   14 +++++++-------
 1 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/src/switch/switch/switch-init.c b/src/switch/switch/switch-init.c
index 9964973..ebf76b0 100644
--- a/src/switch/switch/switch-init.c
+++ b/src/switch/switch/switch-init.c
@@ -113,6 +113,13 @@ init_parse_args( int argc, char **argv ) {
   init_log( name, switch_log, log_output_type );
   xfree( switch_log );
 
+  ignore_sigpipe();
+#ifdef NOT_TESTED
+  if ( args->run_as_daemon == true ) {
+    daemonize( get_switch_home() );
+  }
+#endif
+
   char *switch_pid_dir = get_switch_pid_dir();
   write_pid( switch_pid_dir, name );
   char cmd[ PATH_MAX ];
@@ -124,13 +131,6 @@ init_parse_args( int argc, char **argv ) {
   system( cmd );
   xfree( switch_pid_dir );
 
-  ignore_sigpipe();
-#ifdef NOT_TESTED
-  if ( args->run_as_daemon == true ) {
-    daemonize( get_switch_home() );
-  }
-#endif
-
   return args;
 }
 
-- 
1.7.9

